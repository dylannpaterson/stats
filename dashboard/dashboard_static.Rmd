---
title: "Household Estimates Dashboard"
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)
library(readr)
library(ggplot2)
library(plotly)
library(dplyr)
library(crosstalk)
library(tidyr)

# Read the data
ta_data <- read_csv("../data/outputs/combined_ta_summary.csv")
sa2_data <- read_csv("../data/outputs/combined_sa2_summary.csv")

# Convert to factors
ta_data$household_composition_code <- as.factor(ta_data$household_composition_code)
ta_data$num_bedrooms <- as.factor(ta_data$num_bedrooms)
sa2_data$household_composition_code <- as.factor(sa2_data$household_composition_code)
sa2_data$num_bedrooms <- as.factor(sa2_data$num_bedrooms)

# Summarize SA2 data
sa2_summary <- sa2_data %>%
  group_by(ta_code, household_composition_code, num_bedrooms) %>%
  summarise(sa2_obs_value_sum = sum(OBS_VALUE, na.rm = TRUE),
            sa2_model_mean_sum = sum(estimated_count_mean, na.rm = TRUE))

# Summarize TA data
ta_summary <- ta_data %>%
  group_by(area_code, household_composition_code, num_bedrooms) %>%
  summarise(ta_suppressed_count = sum(suppressed_count, na.rm = TRUE),
            ta_model_mean = sum(estimated_count_mean, na.rm = TRUE))

# Join data
comparison_data <- ta_summary %>%
  left_join(sa2_summary, by = c("area_code" = "ta_code", "household_composition_code", "num_bedrooms"))

# Reshape data
long_comparison_data <- comparison_data %>%
  pivot_longer(cols = c(ta_suppressed_count, sa2_obs_value_sum, ta_model_mean, sa2_model_mean_sum),
               names_to = "data_source",
               values_to = "count")

# Create a shared data object
shared_data <- SharedData$new(long_comparison_data, key = ~area_code)

```

```{r, echo=FALSE}
bscols(
  widths = c(3, 9),
  filter_select("selected_ta", "Select a TA", shared_data, ~area_code, multiple = FALSE),
  ggplotly(
    ggplot(shared_data, aes(x = num_bedrooms, y = count, fill = data_source)) +
      geom_bar(stat = "identity", position = "dodge") +
      labs(title = "TA vs SA2 Comparison",
           x = "Number of Bedrooms",
           y = "Count",
           fill = "Data Source") +
      theme_minimal() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1))
  )
)
```